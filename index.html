<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scripts Page</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
  <div class="sidebar" id="sidebar">
    <button id="sidebar-toggle" aria-label="Toggle sidebar">⮞</button>
    <div class="sidebar-header">
      <img src="assets/discord-icon-tbg.png" alt="Discord Server" class="site-logo">
    </div>
    <input type="text" placeholder="Search scripts..." class="script-search" id="script-search">
    <ul id="script-list" class="folder-tree"></ul>
    <div class="sidebar-footer">
      <a href="https://discord.gg/Gm7fjxaD3h" target="_blank">
        <img src="assets/discord_link.png" alt="Join Discord" class="discord-footer-icon">
      </a>
    </div>
  </div>

  <div class="main-content" id="main-content">
    <div class="breadcrumbs"></div>
    <pre id="script-content">Select a script from the sidebar to view its contents.</pre>
  </div>

  <script type="module">
    import scripts from './generated/scripts.js';

    const listEl = document.getElementById("script-list");
    const contentEl = document.getElementById("script-content");
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.getElementById("main-content");
    const sidebarToggle = document.getElementById("sidebar-toggle");
    const searchBar = document.getElementById("script-search");
    const breadcrumbs = document.querySelector(".breadcrumbs");

    const openFolders = new Set();
    let selectedLi = null;
    const baseUrl = `${window.location.origin}/project-scripts-misc/generated/scripts/`;

    // Prism.js
    const prismScript = document.createElement('script');
    prismScript.src = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js';
    prismScript.defer = true;
    document.body.appendChild(prismScript);
    const prismLangScript = document.createElement('script');
    prismLangScript.src = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js';
    prismLangScript.defer = true;
    document.body.appendChild(prismLangScript);

    // Sidebar toggle
    let sidebarExpanded = true;
    sidebarToggle.addEventListener("click", () => {
      sidebarExpanded = !sidebarExpanded;
      sidebar.classList.toggle("collapsed", !sidebarExpanded);
      sidebarToggle.textContent = sidebarExpanded ? "⮞" : "⮜";
      mainContent.style.marginLeft = sidebarExpanded ? "" : "56px";
    });

    // Build tree structure
    function buildTree(paths) {
      const root = {};
      for (const path of paths) {
        const parts = path.split("/");
        let node = root;
        for (const part of parts) {
          if (!node[part]) node[part] = {};
          node = node[part];
        }
        node.__file = path;
      }
      return root;
    }

    // Render tree with smooth auto-height
    function renderTree(node, parentUl, parentPath = []) {
      Object.entries(node).forEach(([key, value]) => {
        if (key === "__file") return;

        if (value.__file) {
          // File
          const li = document.createElement("li");
          li.classList.add("file");
          const a = document.createElement("a");
          a.href = "#";
          a.textContent = key.length > 32 ? key.slice(0, 29) + "..." : key;
          a.title = key;
          a.dataset.name = key;
          a.addEventListener("click", (e) => {
            e.preventDefault();
            fetch(baseUrl + value.__file)
              .then(res => res.ok ? res.text() : Promise.reject())
              .then(text => {
                if (window.Prism) {
                  contentEl.innerHTML = `<pre class='language-javascript'><code class='language-javascript'>${Prism.highlight(text, Prism.languages.javascript,'javascript')}</code></pre>`;
                } else { contentEl.textContent = text; }
              }).catch(() => contentEl.textContent = "Error loading file.");
            if (selectedLi) selectedLi.classList.remove("selected");
            li.classList.add("selected");
            selectedLi = li;
            breadcrumbs.innerHTML = parentPath.concat(key).map((p, i, arr) => {
              if (i === arr.length - 1) return `<span>${p}</span>`;
              return `<span>${p}</span> <span class='crumb-sep'>/</span>`;
            }).join("");
          });
          li.appendChild(a);
          parentUl.appendChild(li);
        } else {
          // Folder
          const li = document.createElement("li");
          li.classList.add("folder");
          li.dataset.name = key;
          const label = document.createElement("span");
          label.textContent = key;
          label.classList.add("folder-label");
          label.dataset.name = key;
          li.appendChild(label);

          const nestedUl = document.createElement("ul");
          li.appendChild(nestedUl);

          const fullPath = parentPath.concat(key).join("/");
          if (openFolders.has(fullPath)) {
            li.classList.add("open");
            label.classList.add("open");
            nestedUl.style.display = "block";
            nestedUl.style.maxHeight = nestedUl.scrollHeight + "px";
          }

          // Updated click handler with dynamic parent height adjustment
          label.addEventListener("click", () => {
            const isOpen = li.classList.toggle("open");
            label.classList.toggle("open", isOpen);

            function setUlHeight(ul, open) {
              if (open) {
                ul.style.display = "block";
                const height = ul.scrollHeight + "px";
                ul.style.maxHeight = "0px";
                requestAnimationFrame(() => {
                  ul.style.maxHeight = height;
                });
              } else {
                ul.style.maxHeight = ul.scrollHeight + "px";
                requestAnimationFrame(() => {
                  ul.style.maxHeight = "0px";
                });
              }
            }

            setUlHeight(nestedUl, isOpen);

            // Update all parent ULs recursively
            let parent = li.parentNode;
            while (parent && parent.tagName === "UL") {
              const totalHeight = Array.from(parent.children)
                .map(c => c.scrollHeight)
                .reduce((a, b) => a + b, 0);
              parent.style.maxHeight = totalHeight + "px";
              parent = parent.parentNode.closest("ul");
            }

            // Close siblings if opening
            if (isOpen) {
              const siblings = Array.from(li.parentNode.children).filter(
                sib => sib !== li && sib.classList.contains('folder')
              );
              siblings.forEach(sib => {
                sib.classList.remove('open');
                sib.querySelector('span.folder-label')?.classList.remove('open');
                const sibUl = sib.querySelector('ul');
                if (sibUl) sibUl.style.maxHeight = '0px';
                openFolders.delete(parentPath.concat(sib.dataset.name).join("/"));
              });
              openFolders.add(fullPath);
            } else {
              openFolders.delete(fullPath);
            }
          });

          parentUl.appendChild(li);
          renderTree(value, nestedUl, parentPath.concat(key));
        }
      });
    }

    function renderSidebar(filter = "") {
      listEl.innerHTML = "";
      const filteredScripts = filter ? scripts.filter(s => s.toLowerCase().includes(filter.toLowerCase())) : scripts;
      const tree = buildTree(filteredScripts);
      renderTree(tree, listEl);
    }

    renderSidebar();
    searchBar.addEventListener("input", e => renderSidebar(e.target.value));
  </script>
</body>
</html>
