<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scripts Page</title>
  <link rel="stylesheet" href="style.css">
  <!-- Prism.js for syntax highlighting -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
  <img src="assets/discord-icon-tbg.png" alt="Discord Server" class="server-icon">
    </div>
    <ul id="script-list" class="folder-tree"></ul>
    <div class="sidebar-footer">
      <a href="https://discord.gg/Gm7fjxaD3h" target="_blank">
        <img src="assets/discord_link.png" alt="Join Discord" class="discord-footer-icon">
      </a>
    </div>
  </div>

  <div class="main-content">
    <pre id="script-content">Select a script from the sidebar to view its contents.</pre>
  </div>

  <script type="module">
    import scripts from './generated/scripts.js';
    // Prism.js loader
    const prismScript = document.createElement('script');
    prismScript.src = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js';
    prismScript.defer = true;
    document.body.appendChild(prismScript);
    const prismLangScript = document.createElement('script');
    prismLangScript.src = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js';
    prismLangScript.defer = true;
    document.body.appendChild(prismLangScript);

    const listEl = document.getElementById("script-list");
    const contentEl = document.getElementById("script-content");

    // Add search bar
    const searchBar = document.createElement("input");
    searchBar.type = "text";
    searchBar.placeholder = "Search scripts...";
    searchBar.className = "script-search";
    listEl.parentNode.insertBefore(searchBar, listEl);

    // Add breadcrumbs
    const breadcrumbs = document.createElement("div");
    breadcrumbs.className = "breadcrumbs";
    contentEl.parentNode.insertBefore(breadcrumbs, contentEl);

    let selectedLi = null;
    const baseUrl = `${window.location.origin}/project-scripts-misc/generated/scripts/`;

    // Helper to build tree structure from script paths
    function buildTree(paths) {
      const root = {};
      for (const path of paths) {
        const parts = path.split("/");
        let node = root;
        for (const part of parts) {
          if (!node[part]) node[part] = {};
          node = node[part];
        }
        node.__file = path;
      }
      return root;
    }

    // Helper to render tree
    function renderTree(node, parentUl, parentPath = []) {
      Object.entries(node).forEach(([key, value]) => {
        if (key === "__file") return;
        if (value.__file) {
          // file
          const li = document.createElement("li");
          li.classList.add("file");
          const a = document.createElement("a");
          a.href = "#";
          a.textContent = key.length > 32 ? key.slice(0, 29) + "..." : key;
          a.title = key;
          a.addEventListener("click", (e) => {
            e.preventDefault();
            fetch(baseUrl + value.__file)
              .then(res => res.ok ? res.text() : Promise.reject())
                .then(text => {
                  // Wait for Prism to load
                  if (window.Prism) {
                    contentEl.innerHTML = `<pre class='language-javascript'><code class='language-javascript'>${Prism.highlight(text, Prism.languages.javascript, 'javascript')}</code></pre>`;
                  } else {
                    contentEl.textContent = text;
                  }
                })
              .catch(() => contentEl.textContent = "Error loading file.");
            if (selectedLi) selectedLi.classList.remove("selected");
            li.classList.add("selected");
            selectedLi = li;
            // Update breadcrumbs
            breadcrumbs.innerHTML = parentPath.concat(key).map((p, i, arr) => {
              if (i === arr.length - 1) return `<span>${p}</span>`;
              return `<span>${p}</span> <span class='crumb-sep'>/</span>`;
            }).join("");
          });
          li.appendChild(a);
          parentUl.appendChild(li);
        } else {
          // folder
          const li = document.createElement("li");
          li.classList.add("folder");
          li.dataset.name = key;
          const label = document.createElement("span");
          label.textContent = key;
          label.classList.add("folder-label");
          li.appendChild(label);
          const nestedUl = document.createElement("ul");
          li.appendChild(nestedUl);
          label.addEventListener("click", () => {
            nestedUl.classList.toggle("collapsed");
          });
          parentUl.appendChild(li);
          renderTree(value, nestedUl, parentPath.concat(key));
        }
      });
    }

    // Initial render
    function renderSidebar(filter = "") {
      listEl.innerHTML = "";
      const tree = buildTree(
        filter ? scripts.filter(s => s.toLowerCase().includes(filter.toLowerCase())) : scripts
      );
      renderTree(tree, listEl);
    }

    renderSidebar();

    // Search functionality
    searchBar.addEventListener("input", e => {
      renderSidebar(e.target.value);
    });
  </script>
</body>
</html>
