<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Folder Tree Viewer</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
</head>
<body>
  <div class="sidebar" id="sidebar">
    <img src="logo.png" alt="Logo" class="site-logo" />
    <input type="text" id="searchBar" placeholder="Search files...">
    <ul id="fileList"></ul>
    <div class="discord-footer">
      <img src="discord.png" class="discord-footer-icon" alt="Discord">
    </div>
  </div>

  <div class="main">
    <div id="breadcrumbs" class="breadcrumbs"></div>
    <div id="content" class="content"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script>
    const baseUrl = "./"; // root for fetching files
    const scripts = [
      "src/index.js",
      "src/components/Button.js",
      "src/components/Icon.js",
      "src/utils/helpers/math.js",
      "src/utils/helpers/strings.js",
      "README.md"
    ];

    const listEl = document.getElementById("fileList");
    const contentEl = document.getElementById("content");
    const breadcrumbs = document.getElementById("breadcrumbs");
    const searchBar = document.getElementById("searchBar");
    let selectedLi = null;
    const openFolders = new Set();

    // Build tree structure
    function buildTree(paths) {
      const root = {};
      for (const path of paths) {
        const parts = path.split("/");
        let node = root;
        for (const part of parts) {
          if (!node[part]) node[part] = {};
          node = node[part];
        }
        node.__file = path;
      }
      return root;
    }

    // Render tree with persistent folder state
    function renderTree(node, parentUl, parentPath = []) {
      Object.entries(node).forEach(([key, value]) => {
        if (key === "__file") return;

        if (value.__file) {
          // file node
          const li = document.createElement("li");
          li.classList.add("file");
          const a = document.createElement("a");
          a.href = "#";
          a.textContent = key.length > 32 ? key.slice(0, 29) + "..." : key;
          a.title = key;
          a.dataset.name = key;
          a.addEventListener("click", (e) => {
            e.preventDefault();
            fetch(baseUrl + value.__file)
              .then((res) => res.ok ? res.text() : Promise.reject())
              .then((text) => {
                if (window.Prism) {
                  contentEl.innerHTML =
                    `<pre class='language-javascript'><code class='language-javascript'>${Prism.highlight(text, Prism.languages.javascript, 'javascript')}</code></pre>`;
                } else {
                  contentEl.textContent = text;
                }
              })
              .catch(() => (contentEl.textContent = "Error loading file."));
            if (selectedLi) selectedLi.classList.remove("selected");
            li.classList.add("selected");
            selectedLi = li;
            breadcrumbs.innerHTML = parentPath.concat(key).map((p, i, arr) => {
              if (i === arr.length - 1) return `<span>${p}</span>`;
              return `<span>${p}</span> <span class='crumb-sep'>/</span>`;
            }).join("");
          });
          li.appendChild(a);
          parentUl.appendChild(li);
        } else {
          // folder node
          const li = document.createElement("li");
          li.classList.add("folder");
          li.dataset.name = key;
          const label = document.createElement("span");
          label.textContent = key;
          label.classList.add("folder-label");
          label.dataset.name = key;
          li.appendChild(label);

          const nestedUl = document.createElement("ul");
          li.appendChild(nestedUl);

          const fullPath = parentPath.concat(key).join("/");
          if (openFolders.has(fullPath)) {
            li.classList.add("open");
            label.classList.add("open");
          }

          label.addEventListener("click", () => {
            const isOpen = li.classList.toggle("open");
            label.classList.toggle("open", isOpen);

            if (isOpen) {
              openFolders.add(fullPath);
            } else {
              openFolders.delete(fullPath);
            }
          });

          parentUl.appendChild(li);
          renderTree(value, nestedUl, parentPath.concat(key));
        }
      });
    }

    function renderSidebar(filter = "") {
      listEl.innerHTML = "";
      const tree = buildTree(
        filter
          ? scripts.filter((s) =>
              s.toLowerCase().includes(filter.toLowerCase())
            )
          : scripts
      );
      renderTree(tree, listEl);
    }
    renderSidebar();

    searchBar.addEventListener("input", (e) => {
      renderSidebar(e.target.value);
    });
  </script>
</body>
</html>
